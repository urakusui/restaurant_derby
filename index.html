<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>王将ダービー</title>
<style>
body { font-family: system-ui, -apple-system; background: #f5f5f5; padding: 10px; }
.hidden { display: none !important; }
.box { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
input, button { width: 100%; margin: 5px 0; padding: 12px; font-size: 16px; box-sizing: border-box; }
button { border: none; border-radius: 6px; font-weight: bold; color: #fff; cursor: pointer; }
button:disabled { background: #ccc !important; cursor: not-allowed; opacity: 0.6; }
button:active:not(:disabled) { transform: scale(0.98); opacity: 0.9; }

.btn-main { background: linear-gradient(#C62828, #B71C1C); }
.btn-add { background: linear-gradient(#2E7D32, #1B5E20); }
.btn-start { background: linear-gradient(#FDD835, #F9A825); color: #000; }
.btn-back { background: linear-gradient(#616161, #424242); }
.btn-danger { background: linear-gradient(#EF6C00, #E65100); }

.result-slot { padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 4px; background: #fafafa; cursor: pointer; position: relative; }
.result-slot.active { border: 2px solid #F9A825; background: #fffde7; font-weight: bold; }
.result-slot::after { content: "修正する"; position: absolute; right: 10px; font-size: 10px; color: #999; font-weight: normal; }

.ticket { border: 2px dashed #333; padding: 15px; font-family: monospace; background: #fff; }
.ticket-title { text-align: center; font-weight: bold; color: #B71C1C; font-size: 1.2rem; }
hr { border: 0; border-top: 1px solid #ccc; margin: 10px 0; }

#menuList, #playerList, #historyList { max-height: 250px; overflow-y: auto; margin: 10px 0; padding: 5px; background: #eee; border-radius: 4px; font-size: 14px; }
.odds-tag { font-size: 0.8em; color: #666; margin-left: 5px; }
</style>
</head>
<body>

<div id="screen-menu" class="box">
  <h2>王将ダービー</h2>
  <input id="shopInput" placeholder="店名" list="shopHistory">
  <datalist id="shopHistory"></datalist>
  <input id="menuInput" placeholder="メニュー名" list="menuHistory">
  <datalist id="menuHistory"></datalist>
  <button class="btn-add" onclick="addMenu()">メニュー追加</button>
  <div id="menuList">メニューを追加してください</div>
  <button class="btn-main" onclick="startPlayers()">次へ</button>
  <button class="btn-back" onclick="showHistory()">履歴を見る</button>
  <button class="btn-danger" onclick="clearTopCache()">店名・メニューをクリア</button>
</div>

<div id="screen-player" class="box hidden">
  <h3>参加者登録</h3>
  <input id="playerInput" placeholder="参加者名" list="playerHistory">
  <datalist id="playerHistory"></datalist>
  <button class="btn-add" onclick="addPlayer()">参加者を追加</button>
  <div id="playerList">参加者がいません</div>
  <button class="btn-start" onclick="startPrediction()">予想開始</button>
  <button class="btn-back" onclick="show('screen-menu')">戻る</button>
</div>

<div id="screen-prediction" class="box hidden">
  <h3 id="playerTitle"></h3>
  <p style="font-size:12px; color:#666;">※枠をタップすると選択を解除して修正できます</p>
  <div class="box">
    <div id="pslot0" class="result-slot active" onclick="clearPredictSlot(0)">1着：<span id="slot1">未選択</span></div>
    <div id="pslot1" class="result-slot" onclick="clearPredictSlot(1)">2着：<span id="slot2">未選択</span></div>
    <div id="pslot2" class="result-slot" onclick="clearPredictSlot(2)">3着：<span id="slot3">未選択</span></div>
  </div>
  <div id="menuChoices"></div>
  <button class="btn-main" onclick="savePrediction()">確定</button>
</div>

<div id="screen-result" class="box hidden">
  <h3>到着結果（1〜3着を選択）</h3>
  <div class="box">
    <div id="rslot_ui0" class="result-slot active" onclick="clearResultSlot(0)">1着：<span id="rslot1">未選択</span></div>
    <div id="rslot_ui1" class="result-slot" onclick="clearResultSlot(1)">2着：<span id="rslot2">未選択</span></div>
    <div id="rslot_ui2" class="result-slot" onclick="clearResultSlot(2)">3着：<span id="rslot3">未選択</span></div>
  </div>
  <div id="resultChoices"></div>
  <button class="btn-main" onclick="judge()">結果発表</button>
</div>

<div id="screen-ticket" class="box hidden">
  <div class="ticket">
    <div class="ticket-title" id="raceTitle"></div>
    <div style="text-align:center" id="ticketDate"></div>
    <hr>
    <div id="ticketResult"></div>
    <hr>
    <div id="ticketWinners"></div>
    <hr>
    <div id="ticketPredictions"></div>
  </div>
  <button class="btn-back" style="margin-top:15px" onclick="resetApp()">トップに戻る</button>
</div>

<div id="screen-history" class="box hidden">
  <h3>過去の履歴</h3>
  <div id="historyList"></div>
  <button class="btn-back" onclick="show('screen-menu')">戻る</button>
</div>

<script>
let menus=[], players=[], currentPlayer=0, tempPrediction=[null,null,null], tempResult=[null,null,null], activePredictSlot=0, activeResultSlot=0;
const $ = (id) => document.getElementById(id);

function show(id){
  document.querySelectorAll("[id^='screen']").forEach(d => d.classList.add("hidden"));
  const target = $(id);
  if(target) target.classList.remove("hidden");
}

function today(){ const d=new Date(); return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }

/* 履歴読み込み */
function loadAllHistories(){
  $("shopHistory").innerHTML = JSON.parse(localStorage.getItem("shopNameHistory")||"[]").map(v=>`<option value="${v}">`).join("");
  $("menuHistory").innerHTML = JSON.parse(localStorage.getItem("menuNameHistory")||"[]").map(v=>`<option value="${v}">`).join("");
  $("playerHistory").innerHTML = JSON.parse(localStorage.getItem("playerHistory")||"[]").map(v=>`<option value="${v}">`).join("");
}
window.onload = loadAllHistories;

/* トップ操作 */
function addMenu(){
  const val = $("menuInput").value.trim();
  if(!val) return;
  if(menus.some(m => m.name === val)) { alert("既に追加されています"); return; }
  
  const menu = {name: val, odds: (Math.random() * 8 + 1).toFixed(1)};
  menus.push(menu);
  $("menuList").innerHTML = menus.map((m,i)=>`${i+1}. ${m.name} <span class="odds-tag">(${m.odds}倍)</span>`).join("<br>");
  
  let h = JSON.parse(localStorage.getItem("menuNameHistory")||"[]");
  if(!h.includes(val)){ h.unshift(val); localStorage.setItem("menuNameHistory", JSON.stringify(h.slice(0,20))); loadAllHistories(); }
  $("menuInput").value = "";
}

function clearTopCache(){ if(confirm("クリアしますか？")){ menus=[]; $("menuList").innerHTML="メニューを追加してください"; } }

function startPlayers(){
  if(menus.length < 3) return alert("メニューを3つ以上登録してください");
  show("screen-player");
}

function addPlayer(){
  const val = $("playerInput").value.trim();
  if(!val) return;
  players.push({name: val, prediction: []});
  $("playerList").innerHTML = players.map(p => p.name).join("<br>");
  let h = JSON.parse(localStorage.getItem("playerHistory")||"[]");
  if(!h.includes(val)){ h.unshift(val); localStorage.setItem("playerHistory", JSON.stringify(h.slice(0,20))); loadAllHistories(); }
  $("playerInput").value = "";
}

/* 予想・修正ロジック */
function nextStepPrediction(){
  if(currentPlayer >= players.length){ showResultSelect(); return; }
  const p = players[currentPlayer];
  if(p.name.includes("CPU")){ currentPlayer++; nextStepPrediction(); return; }
  
  tempPrediction = [null, null, null]; 
  activePredictSlot = 0;
  $("playerTitle").innerText = `予想：${p.name}`;
  updatePredictUI(); 
  show("screen-prediction");
}

function clearPredictSlot(i){
  tempPrediction[i] = null;
  activePredictSlot = i;
  updatePredictUI();
}

function updatePredictUI(){
  [1,2,3].forEach(i => {
    const mIdx = tempPrediction[i-1];
    $(`slot${i}`).innerText = mIdx ? `${menus[mIdx-1].name} (${menus[mIdx-1].odds}倍)` : "未選択";
  });
  [0,1,2].forEach(i => $(`pslot${i}`).classList.toggle("active", i === activePredictSlot));
  
  $("menuChoices").innerHTML = menus.map((m,i) => {
    const menuIndex = i + 1;
    const isSelected = tempPrediction.includes(menuIndex);
    return `<button class="btn-add" onclick="selectMenu(${menuIndex})" ${isSelected ? 'disabled' : ''}>${m.name} (${m.odds}倍)</button>`;
  }).join("");
}

function selectMenu(n){
  tempPrediction[activePredictSlot] = n;
  // 次の空きスロットを探す
  const nextEmpty = tempPrediction.indexOf(null);
  if(nextEmpty !== -1) activePredictSlot = nextEmpty;
  updatePredictUI();
}

function startPrediction(){
  if(players.length === 0) return alert("参加者を追加してください");
  players.push({name:"CPU(料理人)", prediction:[...Array(menus.length).keys()].map(i=>i+1).sort(()=>Math.random()-0.5).slice(0,3)});
  currentPlayer = 0;
  nextStepPrediction();
}

function savePrediction(){
  if(tempPrediction.filter(n=>n).length < 3) return alert("3つ選んでください");
  players[currentPlayer].prediction = [...tempPrediction];
  currentPlayer++;
  nextStepPrediction();
}

/* 結果・修正ロジック */
function showResultSelect(){
  tempResult = [null, null, null]; 
  activeResultSlot = 0;
  updateResultUI();
  show("screen-result");
}

function clearResultSlot(i){
  tempResult[i] = null;
  activeResultSlot = i;
  updateResultUI();
}

function updateResultUI(){
  [1,2,3].forEach(i => {
    const mIdx = tempResult[i-1];
    $(`rslot${i}`).innerText = mIdx ? `${menus[mIdx-1].name} (${menus[mIdx-1].odds}倍)` : "未選択";
  });
  [0,1,2].forEach(i => $(`rslot_ui${i}`).classList.toggle("active", i === activeResultSlot));
  
  $("resultChoices").innerHTML = menus.map((m,i) => {
    const menuIndex = i + 1;
    const isSelected = tempResult.includes(menuIndex);
    return `<button class="btn-start" onclick="selectResult(${menuIndex})" ${isSelected ? 'disabled' : ''}>${m.name} (${m.odds}倍)</button>`;
  }).join("");
}

function selectResult(n){
  tempResult[activeResultSlot] = n;
  const nextEmpty = tempResult.indexOf(null);
  if(nextEmpty !== -1) activeResultSlot = nextEmpty;
  updateResultUI();
}

function judge(){
  if(tempResult.filter(n=>n).length < 3) return alert("3位まで選んでください");
  const shop = $("shopInput").value || "王将";
  $("raceTitle").innerText = `第11R ${shop}記念`;
  $("ticketDate").innerText = today();
  $("ticketResult").innerHTML = tempResult.map((n,i)=>`${i+1}着：${menus[n-1].name} (${menus[n-1].odds}倍)`).join("<br>");
  
  let winners = players.filter(p => p.prediction.every((v,i) => v === tempResult[i])).map(p=>p.name);
  $("ticketWinners").innerHTML = winners.length ? `★的中者：${winners.join(", ")}` : "的中者なし";
  $("ticketPredictions").innerHTML = "【全員の予想】<br>" + players.map(p => `${p.name}: ${p.prediction.map(idx=>menus[idx-1].name).join("→")}`).join("<br>");

  const history = JSON.parse(localStorage.getItem("chukaHistory")||"[]");
  history.unshift({title: `${shop}記念`, date: today(), res: tempResult.map(n=>menus[n-1].name)});
  localStorage.setItem("chukaHistory", JSON.stringify(history.slice(0,10)));
  show("screen-ticket");
}

function showHistory(){
  const h = JSON.parse(localStorage.getItem("chukaHistory")||"[]");
  const listEl = $("historyList");
  listEl.innerHTML = h.length === 0 ? "履歴なし" : h.map(item => `<div class="box" style="font-size:12px; border-left:4px solid #B71C1C"><b>${item.title}</b> (${item.date})<br>結果：${item.res.join(" → ")}</div>`).join("");
  show("screen-history");
}

function resetApp(){ menus=[]; players=[]; show("screen-menu"); $("menuList").innerHTML="メニューを追加してください"; }
</script>
</body>
</html>
