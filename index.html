<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç‹å°†ãƒ€ãƒ¼ãƒ“ãƒ¼</title>
<style>
body { font-family: system-ui, -apple-system; background: #f5f5f5; padding: 10px; overflow-x: hidden; margin: 0; }
.hidden { display: none !important; }
.box { background: #fff; padding: 15px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
input, button { width: 100%; margin: 5px 0; padding: 12px; font-size: 16px; box-sizing: border-box; }
button { border: none; border-radius: 6px; font-weight: bold; color: #fff; cursor: pointer; transition: 0.2s; }
button:disabled { background: #ccc !important; cursor: not-allowed; opacity: 0.6; }
button:active:not(:disabled) { transform: scale(0.96); }

.btn-main { background: linear-gradient(#C62828, #B71C1C); }
.btn-add { background: linear-gradient(#2E7D32, #1B5E20); }
.btn-start { background: linear-gradient(#FDD835, #F9A825); color: #000; }
.btn-back { background: linear-gradient(#616161, #424242); }
.btn-danger { background: linear-gradient(#EF6C00, #E65100); }

#menuList, #playerList, #historyList { 
  max-height: 250px; 
  overflow-y: auto; 
  margin: 10px 0; 
  padding: 10px; 
  background: #f0f0f0; 
  border-radius: 6px; 
  font-size: 16px; 
  line-height: 1.6;
}

.result-slot { padding: 12px; border: 1px solid #ddd; margin: 5px 0; border-radius: 6px; background: #fafafa; cursor: pointer; position: relative; }
.result-slot.active { border: 2px solid #F9A825; background: #fffde7; font-weight: bold; }
.result-slot::after { content: "ä¿®æ­£"; position: absolute; right: 12px; font-size: 11px; color: #999; }

.result-card { border: 2px solid #333; border-radius: 12px; background: #fff; overflow: hidden; position: relative; }
.card-header { background: #B71C1C; color: #fff; padding: 10px; text-align: center; }
.card-body { padding: 20px; text-align: center; }
.card-row { margin: 10px 0; padding: 8px 0; border-bottom: 1px dashed #eee; }
.card-label { font-size: 12px; color: #777; display: block; margin-bottom: 4px; }
.card-value { font-size: 18px; font-weight: bold; color: #333; }
.card-odds { font-size: 24px; color: #C62828; font-weight: 900; }
.card-winners { font-size: 20px; color: #2E7D32; background: #e8f5e9; padding: 10px; border-radius: 8px; }

.odds-tag { color: #888; margin-left: 6px; font-size: 0.9em; }

/* å™´æ°´ã®ã‚ˆã†ãªç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.confetti { position: fixed; width: 10px; height: 10px; bottom: -20px; z-index: 9999; pointer-events: none; animation: fountain var(--duration) ease-out forwards; }
@keyframes fountain {
  0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 1; }
  50% { opacity: 1; }
  100% { transform: translateY(var(--y)) translateX(var(--x)) rotate(720deg); opacity: 0; }
}
</style>
</head>
<body>

<div id="screen-menu" class="box">
  <h2>ç‹å°†ãƒ€ãƒ¼ãƒ“ãƒ¼</h2>
  <input id="shopInput" placeholder="åº—å" list="shopHistory">
  <datalist id="shopHistory"></datalist>
  <input id="menuInput" placeholder="ãƒ¡ãƒ‹ãƒ¥ãƒ¼å" list="menuHistory">
  <datalist id="menuHistory"></datalist>
  <button class="btn-add" onclick="addMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ </button>
  <div id="menuList">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>
  <button class="btn-main" onclick="startPlayers()">æ¬¡ã¸</button>
  <button class="btn-back" onclick="showHistory()">å±¥æ­´ã‚’è¦‹ã‚‹</button>
  <button class="btn-danger" onclick="clearTopCache()">åº—åãƒ»ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
</div>

<div id="screen-history" class="box hidden">
  <h3>éå»ã®å±¥æ­´</h3>
  <div id="historyList">å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
  <button class="btn-back" onclick="show('screen-menu')">æˆ»ã‚‹</button>
</div>

<div id="screen-player" class="box hidden">
  <h3>å‚åŠ è€…ç™»éŒ²</h3>
  <input id="playerInput" placeholder="å‚åŠ è€…å" list="playerHistory">
  <datalist id="playerHistory"></datalist>
  <button class="btn-add" onclick="addPlayer()">å‚åŠ è€…ã‚’è¿½åŠ </button>
  <div id="playerList">å‚åŠ è€…ãŒã„ã¾ã›ã‚“</div>
  <button class="btn-start" onclick="startPrediction()">äºˆæƒ³é–‹å§‹</button>
  <button class="btn-back" onclick="show('screen-menu')">æˆ»ã‚‹</button>
</div>

<div id="screen-prediction" class="box hidden">
  <h3 id="playerTitle"></h3>
  <div class="box">
    <div id="pslot0" class="result-slot active" onclick="clearPredictSlot(0)">1ç€ï¼š<span id="slot1">æœªé¸æŠ</span></div>
    <div id="pslot1" class="result-slot" onclick="clearPredictSlot(1)">2ç€ï¼š<span id="slot2">æœªé¸æŠ</span></div>
    <div id="pslot2" class="result-slot" onclick="clearPredictSlot(2)">3ç€ï¼š<span id="slot3">æœªé¸æŠ</span></div>
  </div>
  <div id="menuChoices"></div>
  <button class="btn-main" onclick="savePrediction()">ç¢ºå®š</button>
</div>

<div id="screen-result" class="box hidden">
  <h3>åˆ°ç€çµæœã‚’é¸æŠ</h3>
  <div class="box">
    <div id="rslot_ui0" class="result-slot active" onclick="clearResultSlot(0)">1ç€ï¼š<span id="rslot1">æœªé¸æŠ</span></div>
    <div id="rslot_ui1" class="result-slot" onclick="clearResultSlot(1)">2ç€ï¼š<span id="rslot2">æœªé¸æŠ</span></div>
    <div id="rslot_ui2" class="result-slot" onclick="clearResultSlot(2)">3ç€ï¼š<span id="rslot3">æœªé¸æŠ</span></div>
  </div>
  <div id="resultChoices"></div>
  <button class="btn-main" onclick="judge()">çµæœç™ºè¡¨</button>
</div>

<div id="screen-ticket" class="box hidden">
  <div class="result-card">
    <div class="card-header">
      <div id="res-raceTitle" style="font-size: 20px; font-weight: bold;"></div>
      <div id="res-date" style="font-size: 12px; opacity: 0.8;"></div>
    </div>
    <div class="card-body">
      <div class="card-row"><span class="card-label">ã€åˆ°ç€çµæœã€‘</span><div id="res-resultList" class="card-value"></div></div>
      <div class="card-row"><span class="card-label">ã€ç¢ºå®šã‚ªãƒƒã‚ºã€‘</span><div id="res-totalOdds" class="card-odds"></div></div>
      <div class="card-row"><span class="card-label">ã€ çš„ä¸­è€… ã€‘</span><div id="res-winners" class="card-winners"></div></div>
    </div>
  </div>
  <div id="ticketPredictions" style="font-size:14px; color:#555; margin-top:10px; padding:10px;"></div>
  <button class="btn-back" style="margin-top:15px" onclick="resetApp()">æœ€åˆã‹ã‚‰</button>
</div>

<script>
let menus=[], players=[], currentPlayer=0, tempPrediction=[null,null,null], tempResult=[null,null,null], activePredictSlot=0, activeResultSlot=0;
const $ = (id) => document.getElementById(id);

function show(id){
  const allScreens = ["screen-menu", "screen-history", "screen-player", "screen-prediction", "screen-result", "screen-ticket"];
  allScreens.forEach(s => { const el = $(s); if(el) el.classList.add("hidden"); });
  const target = $(id);
  if(target) target.classList.remove("hidden");
  window.scrollTo(0, 0);
}

function today(){ const d=new Date(); return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }

function loadAllHistories(){
  $("shopHistory").innerHTML = JSON.parse(localStorage.getItem("shopNameHistory")||"[]").map(v=>`<option value="${v}">`).join("");
  $("menuHistory").innerHTML = JSON.parse(localStorage.getItem("menuNameHistory")||"[]").map(v=>`<option value="${v}">`).join("");
  $("playerHistory").innerHTML = JSON.parse(localStorage.getItem("playerHistory")||"[]").map(v=>`<option value="${v}">`).join("");
}
window.onload = loadAllHistories;

function showHistory(){
  const h = JSON.parse(localStorage.getItem("chukaHistory") || "[]");
  const listEl = $("historyList");
  if(h.length === 0){
    listEl.innerHTML = "<div style='text-align:center; padding:20px; color:#888;'>å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>";
  } else {
    listEl.innerHTML = h.map(item => `
      <div class="box" style="font-size:14px; border-left:5px solid #B71C1C; padding:12px; margin-bottom:10px;">
        <b style="color:#B71C1C; font-size:16px;">${item.title}</b> <span style="font-size:11px; color:#888;">(${item.date})</span><br>
        <div style="margin-top:8px;">çµæœï¼š${item.res.join(" â†’ ")}</div>
        <div style="font-weight:bold; margin-top:4px; color:#C62828;">ç¢ºå®šã‚ªãƒƒã‚ºï¼š${item.odds}å€</div>
        <div style="color:${item.winners && item.winners.length > 0 ? '#2E7D32' : '#777'}; font-weight:bold;">çš„ä¸­ï¼š${item.winners && item.winners.length > 0 ? item.winners.join(", ") : "ãªã—"}</div>
      </div>
    `).join("");
  }
  show("screen-history");
}

function addMenu(){
  const val = $("menuInput").value.trim();
  if(!val) return;
  const menu = {name: val, odds: (Math.random() * 8 + 1).toFixed(1)};
  menus.push(menu);
  $("menuList").innerHTML = menus.map((m,i)=>`ãƒ» ${m.name} <span class="odds-tag">(${m.odds}å€)</span>`).join("<br>");
  let h = JSON.parse(localStorage.getItem("menuNameHistory")||"[]");
  if(!h.includes(val)){ h.unshift(val); localStorage.setItem("menuNameHistory", JSON.stringify(h.slice(0,20))); loadAllHistories(); }
  $("menuInput").value = "";
}

function clearTopCache(){ if(confirm("ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")){ menus=[]; $("menuList").innerHTML="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„"; } }

function startPlayers(){
  if(menus.length < 3) return alert("ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’3ã¤ä»¥ä¸Šç™»éŒ²ã—ã¦ãã ã•ã„");
  show("screen-player");
}

function addPlayer(){
  const val = $("playerInput").value.trim();
  if(!val) return;
  players.push({name: val, prediction: []});
  $("playerList").innerHTML = players.map(p => `ãƒ» ${p.name}`).join("<br>");
  $("playerInput").value = "";
}

function clearPredictSlot(i){ tempPrediction[i] = null; activePredictSlot = i; updatePredictUI(); }

function updatePredictUI(){
  [1,2,3].forEach(i => {
    const mIdx = tempPrediction[i-1];
    $(`slot${i}`).innerText = mIdx ? `${menus[mIdx-1].name} (${menus[mIdx-1].odds}å€)` : "æœªé¸æŠ";
  });
  [0,1,2].forEach(i => $(`pslot${i}`).classList.toggle("active", i === activePredictSlot));
  $("menuChoices").innerHTML = menus.map((m,i) => {
    const menuIndex = i + 1;
    return `<button class="btn-add" onclick="selectMenu(${menuIndex})" ${tempPrediction.includes(menuIndex) ? 'disabled' : ''}>${m.name} (${m.odds}å€)</button>`;
  }).join("");
}

function selectMenu(n){
  tempPrediction[activePredictSlot] = n;
  const nextEmpty = tempPrediction.indexOf(null);
  if(nextEmpty !== -1) activePredictSlot = nextEmpty;
  updatePredictUI();
}

function nextStepPrediction(){
  if(currentPlayer >= players.length){ showResultSelect(); return; }
  const p = players[currentPlayer];
  if(p.name.includes("CPU")){ currentPlayer++; nextStepPrediction(); return; }
  tempPrediction = [null, null, null]; activePredictSlot = 0;
  $("playerTitle").innerText = `äºˆæƒ³ï¼š${p.name}`;
  updatePredictUI(); show("screen-prediction");
}

function startPrediction(){
  if(players.length === 0) return alert("å‚åŠ è€…ã‚’è¿½åŠ ã—ã¦ãã ã•ã„");
  players.push({name:"CPU(æ–™ç†äºº)", prediction:[...Array(menus.length).keys()].map(i=>i+1).sort(()=>Math.random()-0.5).slice(0,3)});
  currentPlayer = 0; nextStepPrediction();
}

function savePrediction(){
  if(tempPrediction.filter(n=>n).length < 3) return alert("3ã¤é¸ã‚“ã§ãã ã•ã„");
  players[currentPlayer].prediction = [...tempPrediction];
  currentPlayer++; nextStepPrediction();
}

function showResultSelect(){
  tempResult = [null, null, null]; activeResultSlot = 0;
  updateResultUI(); show("screen-result");
}

function clearResultSlot(i){ tempResult[i] = null; activeResultSlot = i; updateResultUI(); }

function updateResultUI(){
  [1,2,3].forEach(i => {
    const mIdx = tempResult[i-1];
    $(`rslot${i}`).innerText = mIdx ? `${menus[mIdx-1].name} (${menus[mIdx-1].odds}å€)` : "æœªé¸æŠ";
  });
  [0,1,2].forEach(i => $(`rslot_ui${i}`).classList.toggle("active", i === activeResultSlot));
  $("resultChoices").innerHTML = menus.map((m,i) => {
    const menuIndex = i + 1;
    return `<button class="btn-start" onclick="selectResult(${menuIndex})" ${tempResult.includes(menuIndex) ? 'disabled' : ''}>${m.name} (${m.odds}å€)</button>`;
  }).join("");
}

function selectResult(n){
  tempResult[activeResultSlot] = n;
  const nextEmpty = tempResult.indexOf(null);
  if(nextEmpty !== -1) activeResultSlot = nextEmpty;
  updateResultUI();
}

function judge(){
  if(tempResult.filter(n=>n).length < 3) return alert("3ä½ã¾ã§é¸ã‚“ã§ãã ã•ã„");
  const shop = $("shopInput").value || "ç‹å°†";
  const suffixes = ["è¨˜å¿µ", "S", "æ¯", "è³", "ã‚«ãƒƒãƒ—"];
  const randomSuffix = suffixes[Math.floor(Math.random() * suffixes.length)];
  const raceTitle = `ç¬¬11R ${shop}${randomSuffix}`;
  
  const date = today();
  let totalOdds = 1.0;
  const resHtml = tempResult.map((n,i) => {
    const m = menus[n-1];
    totalOdds *= parseFloat(m.odds);
    return `${i+1}ç€ï¼š${m.name}`;
  }).join("<br>");

  const finalOdds = totalOdds.toFixed(1);
  $("res-raceTitle").innerText = raceTitle;
  $("res-date").innerText = date;
  $("res-resultList").innerHTML = resHtml;
  $("res-totalOdds").innerText = `3é€£å˜ ${finalOdds}å€`;

  let winners = players.filter(p => p.prediction.every((v,i) => v === tempResult[i])).map(p=>p.name);
  if(winners.length > 0){
    $("res-winners").innerHTML = `ğŸ‰ çš„ä¸­ ğŸ‰<br><span style="font-size:16px">${winners.join(", ")}</span>`;
    launchFountainConfetti();
  } else {
    $("res-winners").innerHTML = "çš„ä¸­è€…ãªã—";
  }

  $("ticketPredictions").innerHTML = "ã€å…¨å“¡ã®äºˆæƒ³ã€‘<br>" + players.map(p => `${p.name}: ${p.prediction.map(idx=>menus[idx-1].name).join("â†’")}`).join("<br>");

  const historyData = JSON.parse(localStorage.getItem("chukaHistory") || "[]");
  historyData.unshift({ 
    title: raceTitle, 
    date: date, 
    res: tempResult.map(n => menus[n-1].name), 
    odds: finalOdds, 
    winners: winners 
  });
  localStorage.setItem("chukaHistory", JSON.stringify(historyData.slice(0, 10)));

  show("screen-ticket");
}

function launchFountainConfetti() {
  const colors = ["#ff0","#f0f","#0ff","#f00","#0f0","#fff"];
  for (let i = 0; i < 60; i++) {
    const c = document.createElement("div");
    c.className = "confetti";
    c.style.left = "50vw";
    c.style.backgroundColor = colors[Math.floor(Math.random()*6)];
    const xMove = (Math.random() - 0.5) * 600; // æ¨ªã®åºƒãŒã‚Š
    const yMove = -(Math.random() * 600 + 400); // ä¸Šã¸ã®é«˜ã•
    const duration = Math.random() * 2 + 1.5;
    c.style.setProperty('--x', `${xMove}px`);
    c.style.setProperty('--y', `${yMove}px`);
    c.style.setProperty('--duration', `${duration}s`);
    document.body.appendChild(c);
    setTimeout(() => c.remove(), duration * 1000);
  }
}

function resetApp(){ 
  menus=[]; players=[]; currentPlayer=0;
  tempPrediction=[null,null,null]; tempResult=[null,null,null];
  $("menuList").innerHTML="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„"; 
  $("playerList").innerHTML="å‚åŠ è€…ãŒã„ã¾ã›ã‚“";
  show("screen-menu"); 
}
</script>
</body>
</html>
