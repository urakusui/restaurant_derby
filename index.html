<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç‹å°†ãƒ€ãƒ¼ãƒ“ãƒ¼</title>
<style>
body { font-family: sans-serif; background: #f5f5f5; padding:15px; margin:0; color:#333; }
* { box-sizing: border-box; }
.hidden { display:none !important; }
.box { background:#fff; padding:20px; margin-bottom:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
.header-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid #eee; padding-bottom:10px; }
h2,h3 { margin:0; color:#B71C1C; }
input, button { width:100%; margin:8px 0; padding:12px; font-size:16px; border-radius:6px; border:1px solid #ccc; }
button { border:none; font-weight:bold; color:#fff; cursor:pointer; transition:0.2s; }
button:active { transform:scale(0.98); }
.btn-main { background:#B71C1C; }
.btn-add { background:#2E7D32; }
.btn-back { background:#616161; }
.btn-del {
  background: #f44336;
  margin-left: 10px;
  width: 24px;
  height: 24px;
  font-size: 14px;
  line-height: 24px;
  text-align: center;
  display: flex;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  border-radius: 50%;
  padding: 0;
}
.list-area { margin:15px 0; max-height:300px; overflow-y:auto; }
.list-item { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:10px 0; }
.modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:9999; }
.modal-content { background:#fff; width:90%; max-width:450px; padding:25px; border-radius:10px; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { border:1px solid #ccc; padding:10px; text-align:center; font-size:14px; }
th { background:#eee; }
.waku-1 { color:#000; } .waku-2 { background:#333; color:#fff; }
.waku-3 { background:#f44336; color:#fff; } .waku-4 { background:#2196f3; color:#fff; }
.waku-5 { background:#ffeb3b; color:#000; } .waku-6 { background:#4caf50; color:#fff; }
.waku-7 { background:#ff9800; color:#fff; } .waku-8 { background:#ffc0cb; color:#000; }

/* --- å¼·åŒ–ç‰ˆç´™å¹é›ª --- */
@keyframes confetti-fall-boost {
  0% {
    transform: translate(0,0) rotate(0deg) scale(1);
    opacity: 1;
  }
  100% {
    transform: translate(var(--tx), var(--ty)) rotate(var(--rotate)deg) scale(0.5);
    opacity: 0;
  }
}
.confetti {
  position: absolute;
  border-radius: 50%;
  animation: confetti-fall-boost 1.5s ease-out forwards;
  z-index: 10000;
  pointer-events: none;
}
</style>
</head>
<body>

<!-- éŠã³æ–¹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal-help" class="modal-overlay hidden">
  <div class="modal-content">
    <h3>ğŸ“– éŠã³æ–¹</h3>
    <ul style="padding-left:20px; line-height:1.6;">
      <li><b>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç™»éŒ²ï¼š</b>é ¼ã‚€æ–™ç†ãƒ»ãƒ‰ãƒªãƒ³ã‚¯ã‚’3ã¤ä»¥ä¸Šå…¥åŠ›ã€‚ï¼ˆæœ€å¤§8å“ï¼‰</li>
      <li><b>å‡ºèµ°è¡¨ï¼š</b>ã€Œå‡ºèµ°è¡¨ã‚’ç¢ºèªã€ã§ã‚ªãƒƒã‚ºã‚’è¡¨ç¤ºã€‚</li>
      <li><b>äºˆæƒ³ï¼š</b>å‚åŠ è€…ã‚’ç™»éŒ²ã—ã€æ–™ç†ã®åˆ°ç€é †ï¼ˆ1ã€œ3ç€ï¼‰ã‚’äºˆæƒ³ã€‚</li>
      <li><b>çµæœï¼š</b>æ–™ç†ãŒå±Šã„ãŸé †ã«å…¥åŠ›ã—ã¦çµæœç™ºè¡¨ï¼</li>
    </ul>
    <button type="button" class="btn-main" onclick="toggleModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- ãƒˆãƒƒãƒ—ç”»é¢ -->
<div id="screen-menu" class="box">
  <div class="header-row">
    <h2>ç‹å°†ãƒ€ãƒ¼ãƒ“ãƒ¼</h2>
    <button type="button" class="btn-main" style="width:40px;height:40px;padding:0;font-size:24px;" onclick="toggleModal()">ï¼Ÿ</button>
  </div>
  <input id="shopName" placeholder="åº—èˆ—åï¼ˆä¾‹ï¼šå¤§é˜ªé§…å‰ç¬¬2ãƒ“ãƒ«ï¼‰" list="shopList">
  <datalist id="shopList"></datalist>
  <input id="menuName" placeholder="ãƒ¡ãƒ‹ãƒ¥ãƒ¼åï¼ˆä¾‹ï¼šé¤ƒå­ï¼‰" list="menuHistoryList">
  <datalist id="menuHistoryList"></datalist>
  <button type="button" class="btn-add" onclick="addMenu()">ï¼‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ </button>
  <div id="menuList" class="list-area">
    <div style="text-align:center; color:#888;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>
  </div>
  <button type="button" class="btn-main" onclick="toRaceTable()">ğŸ å‡ºèµ°è¡¨ã‚’ç¢ºèª</button>
  <button type="button" class="btn-main" onclick="showHistory()">ğŸ“œ å±¥æ­´è¡¨ç¤º</button>
  <button type="button" class="btn-back" onclick="resetAll()">ğŸ—‘ï¸ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
</div>

<!-- å‡ºèµ°è¡¨ -->
<div id="screen-race" class="box hidden">
  <h3>ğŸ å‡ºèµ°è¡¨</h3>
  <div id="raceTableArea"></div>
  <button type="button" class="btn-add" style="margin-top:15px;" onclick="toPlayerReg()">å‚åŠ è€…ç™»éŒ²ã¸é€²ã‚€</button>
  <button type="button" class="btn-back" onclick="show('screen-menu')">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¿®æ­£ã«æˆ»ã‚‹</button>
</div>

<!-- å‚åŠ è€…ç™»éŒ² -->
<div id="screen-player" class="box hidden">
  <h3>ğŸ‘¤ å‚åŠ è€…ç™»éŒ²</h3>
  <input id="playerName" placeholder="åå‰ã‚’å…¥åŠ›">
  <button type="button" class="btn-add" onclick="addPlayer()">ï¼‹ å‚åŠ è€…ã‚’è¿½åŠ </button>
  <div id="playerList" class="list-area">å‚åŠ è€…ãŒã„ã¾ã›ã‚“</div>
  <button type="button" class="btn-main" onclick="startPrediction()">äºˆæƒ³ã‚’å§‹ã‚ã‚‹</button>
  <button type="button" class="btn-back" onclick="show('screen-race')">æˆ»ã‚‹</button>
</div>

<!-- äºˆæƒ³ç”»é¢ -->
<div id="screen-predict" class="box hidden">
  <h3 id="predictTitle">äºˆæƒ³ç”»é¢</h3>
  <p>1ç€ã€œ3ç€ã‚’é¸ã‚“ã§ãã ã•ã„</p>
  <div id="predictInputs"></div>
  <div id="menuButtons"></div>
  <button type="button" class="btn-main" onclick="confirmPrediction()">æ±ºå®š</button>
</div>

<!-- çµæœå…¥åŠ› -->
<div id="screen-result" class="box hidden">
  <h3>ğŸ† çµæœå…¥åŠ›</h3>
  <p>å±Šã„ãŸæ–™ç†ã‚’é †ç•ªã«é¸ã‚“ã§ãã ã•ã„</p>
  <div id="resultInputs"></div>
  <div id="resultButtons"></div>
  <button type="button" class="btn-main" onclick="showResult()">çµæœç™ºè¡¨ï¼</button>
</div>

<!-- çµæœç™ºè¡¨ -->
<div id="screen-ticket" class="box hidden">
  <div style="text-align:center; border:2px solid #333; padding:20px; border-radius:10px; position:relative;">
    <h2 id="finalTitle">çµæœç™ºè¡¨</h2>
    <div id="raceDateTime" style="color:#555; margin-bottom:15px;"></div>
    <div id="raceNumber" style="font-weight:bold; margin:10px 0;"></div>
    <div id="finalResult" style="font-size:16px; margin:15px 0; line-height:1.6;"></div>
    <div id="finalOdds" style="color:#B71C1C; font-size:22px; font-weight:900;"></div>
    <div id="finalWinners" style="color:green; font-weight:bold; font-size:18px; margin-bottom:10px;"></div>
    <hr>
    <div id="allPredictions" style="color:#333; font-size:14px; text-align:left;"></div>
  </div>
  <button type="button" class="btn-back" onclick="resetAll()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
</div>

<!-- å±¥æ­´ç”»é¢ -->
<div id="screen-history" class="box hidden">
  <h3>ğŸ“œ éå»ã®ãƒ¬ãƒ¼ã‚¹å±¥æ­´ï¼ˆæœ€å¤§10ä»¶ï¼‰</h3>
  <div id="historyList" class="list-area">å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
  <button type="button" class="btn-back" onclick="show('screen-menu')">æˆ»ã‚‹</button>
</div>

<script>
let menus=[], players=[], cpuNames=['å±±å²¡å£«éƒ','æ —ç”°ã‚†ã†å­'], currentPlayerIndex=0,
    tempPrediction=[null,null,null], tempResult=[null,null,null], activeSlot=0, history=[];
const $=id=>document.getElementById(id);

function show(id){
  ['screen-menu','screen-race','screen-player','screen-predict','screen-result','screen-ticket','screen-history'].forEach(i=>{$(i).classList.add('hidden');});
  $(id).classList.remove('hidden'); 
  window.scrollTo(0,0);
}
function toggleModal(){ $('modal-help').classList.toggle('hidden'); }

// --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ ---
function addMenu(){ 
  if(menus.length>=8){ alert("ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯æœ€å¤§8å“ã¾ã§ã§ã™"); return; }
  const val=$('menuName').value.trim(); if(!val) return;
  const odds=(Math.random()*8+1.1).toFixed(1); 
  menus.push({name:val,odds:odds}); 
  $('menuName').value=''; 
  renderMenus(); 
  updateMenuHistory(val);
}
function renderMenus(){ 
  const list=$('menuList'); 
  if(menus.length===0){ list.innerHTML='<div style="text-align:center; color:#888;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>'; return;} 
  list.innerHTML=menus.map((m,i)=>`<div class="list-item"><span style="font-weight:bold;">${i+1}. ${m.name}</span><button type="button" class="btn-del" onclick="removeMenu(${i})">â˜“</button></div>`).join('');
}
function removeMenu(i){ menus.splice(i,1); renderMenus(); }
function updateMenuHistory(val){
  let list=$('menuHistoryList');
  if(!Array.from(list.options).some(o=>o.value===val)){ let opt=document.createElement('option'); opt.value=val; list.appendChild(opt);}
}

// --- å‡ºèµ°è¡¨ ---
function toRaceTable(){ 
  if(menus.length<3){ alert("ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’3ã¤ä»¥ä¸Šç™»éŒ²ã—ã¦ãã ã•ã„"); return;}
  let html='<table><tr><th>æ </th><th>ãƒ¡ãƒ‹ãƒ¥ãƒ¼å</th><th>ã‚ªãƒƒã‚º</th></tr>';
  menus.forEach((m,i)=>{ 
    const waku=Math.min(8, Math.floor(i/Math.max(1,menus.length/8))+1); 
    html+=`<tr><td class="waku-${waku}">${i+1}</td><td>${m.name}</td><td>${m.odds}å€</td></tr>`; 
  });
  html+='</table>'; 
  $('raceTableArea').innerHTML=html; 
  show('screen-race');
}

// --- å‚åŠ è€… ---
function toPlayerReg(){ show('screen-player'); }
function addPlayer(){ 
  const val=$('playerName').value.trim(); 
  if(!val) return; 
  players.push({name:val,prediction:[]}); 
  $('playerName').value=''; 
  renderPlayers();
}
function renderPlayers(){ 
  const list=$('playerList'); 
  list.innerHTML=players.length===0?'å‚åŠ è€…ãŒã„ã¾ã›ã‚“':players.map(p=>`<div class="list-item">ğŸ‘¤ ${p.name}</div>`).join('');
}

// --- äºˆæƒ³ ---
function startPrediction(){
  if(players.length===0){alert("å‚åŠ è€…ã‚’è¿½åŠ ã—ã¦ãã ã•ã„"); return;} 
  currentPlayerIndex=0; setupPredictionScreen();
}
function setupPredictionScreen(){ 
  if(currentPlayerIndex>=players.length){ setupResultScreen(); return;}
  const p=players[currentPlayerIndex]; 
  $('predictTitle').innerText=`äºˆæƒ³ï¼š${p.name} ã•ã‚“`; 
  tempPrediction=[null,null,null]; activeSlot=0; renderPredictionUI(); show('screen-predict');
}
function renderPredictionUI(){ 
  const labels=['1ç€','2ç€','3ç€']; let html=''; 
  for(let i=0;i<3;i++){ 
    const menuIdx=tempPrediction[i]; 
    const text=menuIdx!==null?menus[menuIdx].name:'ï¼ˆæœªé¸æŠï¼‰'; 
    const style=(i===activeSlot)?'background:#FFF3E0;border:2px solid orange;':'background:#fff;'; 
    html+=`<div style="padding:10px;margin:5px 0;border:1px solid #ddd;border-radius:4px;${style}" onclick="activeSlot=${i};renderPredictionUI();"><b>${labels[i]}</b> : ${text}</div>`;
  }
  $('predictInputs').innerHTML=html; 
  $('menuButtons').innerHTML=menus.map((m,i)=>{
    return `<button type="button" style="margin:4px 0;background:#eee;color:#333;text-align:left;${tempPrediction.includes(i)?'opacity:0.3;':''}" ${tempPrediction.includes(i)?'disabled':''} onclick="selectMenuForPrediction(${i})">${i+1}. ${m.name} (${m.odds}å€)</button>`;
  }).join('');
}
function selectMenuForPrediction(idx){ tempPrediction[activeSlot]=idx; const next=tempPrediction.indexOf(null); if(next!==-1) activeSlot=next; renderPredictionUI();}
function confirmPrediction(){ 
  if(tempPrediction.includes(null)){alert("1ç€ã‹ã‚‰3ç€ã¾ã§ã™ã¹ã¦é¸ã‚“ã§ãã ã•ã„"); return;} 
  players[currentPlayerIndex].prediction=[...tempPrediction]; 
  currentPlayerIndex++; setupPredictionScreen();
}

// --- çµæœå…¥åŠ› ---
function setupResultScreen(){ tempResult=[null,null,null]; activeSlot=0; renderResultUI(); show('screen-result'); }
function renderResultUI(){ 
  const labels=['1ç€','2ç€','3ç€']; let html=''; 
  for(let i=0;i<3;i++){ const menuIdx=tempResult[i]; const text=menuIdx!==null?menus[menuIdx].name:'ï¼ˆæœªé¸æŠï¼‰'; const style=(i===activeSlot)?'background:#FFF3E0;border:2px solid orange;':'background:#fff;'; 
  html+=`<div style="padding:10px;margin:5px 0;border:1px solid #ddd;border-radius:4px;${style}" onclick="activeSlot=${i};renderResultUI();"><b>${labels[i]}</b> : ${text}</div>`;}
  $('resultInputs').innerHTML=html; 
  $('resultButtons').innerHTML=menus.map((m,i)=>{
    return `<button type="button" style="margin:4px 0;background:#eee;color:#333;text-align:left;${tempResult.includes(i)?'opacity:0.3;':''}" ${tempResult.includes(i)?'disabled':''} onclick="selectMenuForResult(${i})">${i+1}. ${m.name}</button>`;
  }).join('');
}
function selectMenuForResult(idx){ tempResult[activeSlot]=idx; const next=tempResult.indexOf(null); if(next!==-1) activeSlot=next; renderResultUI();}

// --- çµæœç™ºè¡¨ ---
function showResult(){ 
  if(tempResult.includes(null)){alert("ã™ã¹ã¦ã®çµæœã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return;}
  const shop=$('shopName').value||'ç‹å°†'; 
  const date=new Date(); 
  let totalOdds=1.0;
  const raceNum=Math.floor(Math.random()*3+9); // 9ã€œ11
  $('raceNumber').innerText=`ç¬¬${raceNum}R`;
  $('raceDateTime').innerText=`${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;

  const resHtml=tempResult.map((idx,i)=>{
    totalOdds*=parseFloat(menus[idx].odds);
    return `${i+1}ç€: ${menus[idx].name} (${menus[idx].odds}å€)`; // ç€é †æ¨ªã«ã‚ªãƒƒã‚ºè¿½åŠ 
  }).join('<br>');
  $('finalTitle').innerText=`ç¬¬${raceNum}R ${shop} ã‚¹ãƒ†ãƒ¼ã‚¯ã‚¹`; // ã‚¿ã‚¤ãƒˆãƒ«ã«ç¬¬Rï¼‹ã‚¹ãƒ†ãƒ¼ã‚¯ã‚¹
  $('finalResult').innerHTML=resHtml; 
  $('finalOdds').innerText=`ã‚ªãƒƒã‚ºåˆè¨ˆ: ${totalOdds.toFixed(1)}å€`;

  // CPUãƒ©ãƒ³ãƒ€ãƒ çµæœ
  const cpuResults = cpuNames.map(name=>{
    let idxs = [];
    while(idxs.length < 3){
        let r = Math.floor(Math.random()*menus.length);
        if(!idxs.includes(r)) idxs.push(r);
    }
    return {name:name, prediction: idxs};
  });

  // å…¨å“¡äºˆæƒ³è¡¨ç¤ºï¼ˆCPUå«ã‚€ï¼‰
  const allPlayers = [...players, ...cpuResults];
  let allPredHtml = allPlayers.map(p=>`${p.name} : ${p.prediction.map(i=>menus[i].name).join(' â†’ ')}`).join('<br>');
  $('allPredictions').innerHTML = allPredHtml;

  // å…¨å“¡ï¼ˆäººé–“ + CPUï¼‰ã§çš„ä¸­åˆ¤å®š
  let winners = [...players, ...cpuResults].filter(p => p.prediction.every((v,i)=>v===tempResult[i]));
  $('finalWinners').innerText = winners.length>0 ? `ğŸ‰çš„ä¸­è€…ğŸ‰: ${winners.map(p=>p.name).join(', ')}` : ''; // çš„ä¸­è€…è¡¨ç¤º

  show('screen-ticket');
  if(winners.length>0) spawnConfetti(); // çš„ä¸­æ™‚ã«ç´™å¹é›ª

  // å±¥æ­´ä¿å­˜
  history.unshift({date:date, raceNum:raceNum, shop:shop, result:tempResult.map(i=>menus[i].name), winners:winners.map(p=>p.name)}); 
  if(history.length>10) history.pop();
}

// --- ç´™å¹é›ªæ¼”å‡º ---
function spawnConfetti(){ 
  const colors=['#f44336','#e91e63','#ffeb3b','#4caf50','#2196f3','#ff9800','#9c27b0','#9c27b0','#ff5722','#00bcd4'];
  const count = 400; // ç´™å¹é›ªã®æ•°ã‚’å¢—åŠ 
  for(let i=0;i<count;i++){
    const confetti=document.createElement('div');
    confetti.className='confetti';
    confetti.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
    const size = Math.random()*12+6;
    confetti.style.width = `${size}px`;
    confetti.style.height = `${size}px`;

    // åˆæœŸä½ç½®ï¼šç”»é¢ä¸Šéƒ¨ã®ãƒ©ãƒ³ãƒ€ãƒ X
    confetti.style.left = Math.random() * window.innerWidth + 'px';
    confetti.style.top  = '-20px';

    // é£›ã¶è·é›¢ï¼ˆå·¦å³ã¨ä¸‹æ–¹å‘ï¼‰
    const tx = (Math.random()-0.5) * 400;  // -200 ~ +200 px å·¦å³ã«æ‹¡æ•£
    const ty = window.innerHeight + Math.random()*200; // ç”»é¢ä¸‹ã¾ã§è½ä¸‹
    confetti.style.setProperty('--tx', `${tx}px`);
    confetti.style.setProperty('--ty', `${ty}px`);
    confetti.style.setProperty('--rotate', `${Math.random()*720}`);

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ãƒ©ãƒ³ãƒ€ãƒ åŒ–
    confetti.style.animationDuration = `${2 + Math.random()*2}s`;
    confetti.style.opacity = 1;

    document.body.appendChild(confetti);
    setTimeout(()=>{ confetti.remove(); }, 5000);
  }
}

// --- å±¥æ­´è¡¨ç¤º ---
function showHistory(){ 
  show('screen-history'); 
  const list=$('historyList'); 
  if(history.length===0){ list.innerHTML='å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“'; return;} 
  list.innerHTML=history.map(h=>`<div style="margin-bottom:12px; padding:8px; border-bottom:1px dashed #ccc;"><b>${h.shop} ç¬¬${h.raceNum}R</b> (${h.date.toLocaleDateString()} ${h.date.toLocaleTimeString()})<br>çµæœ: ${h.result.join(' â†’ ')}<br>çš„ä¸­è€…: ${h.winners.length>0?h.winners.join(', '):'ãªã—'}</div>`).join('');
}

// --- ãƒªã‚»ãƒƒãƒˆ ---
function resetAll(){ 
  menus=[]; players=[]; history=[]; tempPrediction=[null,null,null]; tempResult=[null,null,null]; activeSlot=0;
  show('screen-menu'); 
  renderMenus(); 
  renderPlayers();
}
</script>
</body>
</html>
