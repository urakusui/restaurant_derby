<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>王将ダービー</title>

<style>
body { font-family: system-ui, -apple-system; background: #f5f5f5; padding: 10px; }
.hidden { display: none; }
.box { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
input, button { width: 100%; margin: 5px 0; padding: 10px; font-size: 16px; box-sizing: border-box; }
button { border: none; border-radius: 6px; font-weight: bold; letter-spacing: 0.05em; color: #fff; cursor: pointer; }
button:active { transform: scale(0.96); box-shadow: inset 0 0 8px rgba(0,0,0,0.6); }

/* ギャンブルUI */
.btn-main { background: linear-gradient(#C62828, #B71C1C); }
.btn-add { background: linear-gradient(#2E7D32, #1B5E20); }
.btn-start { background: linear-gradient(#FDD835, #F9A825); color: #000; }
.btn-back { background: linear-gradient(#616161, #424242); }
.btn-danger { background: linear-gradient(#EF6C00, #E65100); }

.result-slot { cursor: pointer; padding: 8px; border: 1px solid #eee; margin: 2px 0; border-radius: 4px; }
.result-slot.active { font-weight: bold; background-color: #fff9c4; border: 2px solid #F9A825; }

.ticket { border: 2px dashed #000; padding: 12px; font-family: monospace; }
.ticket-title { text-align: center; font-weight: bold; color: #B71C1C; font-size: 1.2em; }
.ticket-sub { text-align: center; margin-bottom: 10px; }

#menuList, #playerList { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 5px; margin: 5px 0; background: #fafafa; }
</style>
</head>
<body>

<div id="screen-menu" class="box">
  <h2>王将ダービー</h2>
  <input id="shopInput" placeholder="店名" list="shopHistory">
  <datalist id="shopHistory"></datalist>
  <input id="menuInput" placeholder="メニュー名" list="menuHistory">
  <datalist id="menuHistory"></datalist>
  <button class="btn-add" onclick="addMenu()">メニュー追加</button>
  <div id="menuList">メニューが追加されていません</div>
  <button class="btn-main" onclick="startPlayers()">次へ</button>
  <button class="btn-back" onclick="showHistory()">履歴を見る</button>
  <button class="btn-danger" onclick="clearTopCache()">店名・メニューをクリア</button>
</div>

<div id="screen-player" class="box hidden">
  <h3>参加者登録</h3>
  <input id="playerInput" placeholder="参加者名" list="playerHistory">
  <datalist id="playerHistory"></datalist>
  <button class="btn-add" onclick="addPlayer()">参加者追加</button>
  <div id="playerList">参加者がいません</div>
  <button class="btn-start" onclick="startPrediction()">予想開始</button>
  <button class="btn-danger" onclick="clearPlayers()">参加者全削除</button>
  <button class="btn-back" onclick="show('screen-menu')">戻る</button>
</div>

<div id="screen-prediction" class="box hidden">
  <h3 id="playerTitle"></h3>
  <div class="box">
    <div id="pslot0" class="result-slot active" onclick="setActivePredictSlot(0)">1着：<span id="slot1">未選択</span></div>
    <div id="pslot1" class="result-slot" onclick="setActivePredictSlot(1)">2着：<span id="slot2">未選択</span></div>
    <div id="pslot2" class="result-slot" onclick="setActivePredictSlot(2)">3着：<span id="slot3">未選択</span></div>
  </div>
  <div class="box" id="menuChoices"></div>
  <button class="btn-main" onclick="savePrediction()">確定</button>
</div>

<div id="screen-result" class="box hidden">
  <h3>到着結果（タップで入れ替え）</h3>
  <div class="box">
    <div id="rslot_ui0" class="result-slot active" onclick="setActiveResultSlot(0)">1着：<span id="rslot1">未選択</span></div>
    <div id="rslot_ui1" class="result-slot" onclick="setActiveResultSlot(1)">2着：<span id="rslot2">未選択</span></div>
    <div id="rslot_ui2" class="result-slot" onclick="setActiveResultSlot(2)">3着：<span id="rslot3">未選択</span></div>
  </div>
  <div class="box" id="resultChoices"></div>
  <button class="btn-main" onclick="judge()">結果を表示する</button>
</div>

<div id="screen-ticket" class="box hidden">
  <div class="ticket">
    <div class="ticket-title" id="raceTitle"></div>
    <div class="ticket-sub" id="ticketDate"></div>
    <div id="ticketResult"></div>
    <div id="ticketOdds"></div>
    <hr>
    <div id="ticketWinners"></div>
    <hr>
    <div id="ticketPredictions"></div>
  </div>
  <button class="btn-back" onclick="resetApp()">最初から遊ぶ</button>
</div>

<div id="screen-history" class="box hidden">
  <h3>これまでの記録</h3>
  <div id="historyList"></div>
  <button class="btn-back" onclick="show('screen-menu')">トップに戻る</button>
</div>

<script>
let menus=[], players=[], currentPlayer=0, tempPrediction=[], tempResult=[], activePredictSlot=0, activeResultSlot=0;

// 要素を確実に取得するための共通関数
const $ = (id) => document.getElementById(id);

function show(id){
  document.querySelectorAll("[id^='screen']").forEach(d=>d.classList.add("hidden"));
  $(id).classList.remove("hidden");
}

function today(){ const d=new Date(); return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`; }
function randomRaceName(shop){ const s=["S","杯","賞","記念","グランプリ"]; return `第11R ${shop}${s[Math.floor(Math.random()*s.length)]}`; }

/* 履歴読み込み */
function loadAllHistories(){
  const mH = JSON.parse(localStorage.getItem("menuNameHistory")||"[]");
  $("shopHistory").innerHTML = JSON.parse(localStorage.getItem("shopNameHistory")||"[]").map(v=>`<option value="${v}">`).join("");
  $("menuHistory").innerHTML = mH.map(v=>`<option value="${v}">`).join("");
  $("playerHistory").innerHTML = JSON.parse(localStorage.getItem("playerHistory")||"[]").map(v=>`<option value="${v}">`).join("");
}

/* ページ読み込み時に実行 */
window.onload = loadAllHistories;

/* トップ */
function clearTopCache(){ 
  if(!confirm("店名とメニューをクリアしますか？")) return; 
  $("shopInput").value=""; $("menuInput").value=""; menus=[]; $("menuList").innerHTML="メニューが追加されていません"; 
}

function addMenu(){ 
  const val = $("menuInput").value;
  if(!val) return; 
  const menu={name:val, odds:(Math.random()*8+1).toFixed(1)}; 
  menus.push(menu); 
  $("menuList").innerHTML = menus.map((m,i)=>`${i+1}. ${m.name}（${m.odds}倍）`).join("<br>"); 
  
  // 履歴保存
  let h=JSON.parse(localStorage.getItem("menuNameHistory")||"[]"); 
  if(!h.includes(val)){h.unshift(val); h=h.slice(0,50); localStorage.setItem("menuNameHistory",JSON.stringify(h)); loadAllHistories();} 
  $("menuInput").value=""; 
}

/* 参加者 */
function startPlayers(){ 
  if(menus.length < 3) return alert("メニューを3つ以上追加してください"); 
  show("screen-player"); 
}

function addPlayer(){ 
  const val = $("playerInput").value;
  if(!val) return; 
  players.push({name:val, prediction:[]}); 
  $("playerList").innerHTML = players.map(p=>p.name).join("<br>"); 
  
  let h=JSON.parse(localStorage.getItem("playerHistory")||"[]"); 
  if(!h.includes(val)){h.unshift(val); h=h.slice(0,50); localStorage.setItem("playerHistory",JSON.stringify(h)); loadAllHistories();} 
  $("playerInput").value=""; 
}

function clearPlayers(){ if(!confirm("参加者をすべて削除しますか？"))return; players=[]; $("playerList").innerHTML="参加者がいません"; }

/* 予想 */
function startPrediction(){ 
  if(players.length === 0) return alert("参加者を追加してください");
  // CPU枠を追加
  players.push({name:"伝説の料理人", prediction:[...menus.keys()].map(i=>i+1).sort(()=>Math.random()-0.5).slice(0,3)}); 
  currentPlayer=0; 
  showPrediction(); 
}

function showPrediction(){
  const p=players[currentPlayer]; 
  if(p.name==="伝説の料理人"){ 
    currentPlayer++; 
    return currentPlayer < players.length ? showPrediction() : showResultSelect(); 
  }
  tempPrediction=[]; activePredictSlot=0; 
  updatePredictSlots();
  $("menuChoices").innerHTML = menus.map((m,i)=>`<button class="btn-add" onclick="selectMenu(${i+1})">${i+1}. ${m.name}</button>`).join("");
  $("playerTitle").innerText = `予想：${p.name}`; 
  show("screen-prediction");
}

function setActivePredictSlot(i){ activePredictSlot=i; updatePredictSlots(); }

function updatePredictSlots(){ 
  [$("slot1"), $("slot2"), $("slot3")].forEach((s,i)=>{ 
    s.innerText = tempPrediction[i] ? menus[tempPrediction[i]-1].name : "未選択"; 
  }); 
  [0,1,2].forEach(idx => {
    $("pslot"+idx).classList.toggle("active", idx === activePredictSlot);
  });
}

function selectMenu(n){ 
  tempPrediction[activePredictSlot]=Number(n); 
  updatePredictSlots(); 
  if(activePredictSlot < 2) {
    activePredictSlot++;
    updatePredictSlots();
  }
}

function savePrediction(){ 
  const valid = tempPrediction.filter(n => n !== undefined && n !== null);
  if(new Set(valid).size !== 3) return alert("重複なく3つすべて選んでください"); 
  players[currentPlayer].prediction=[...tempPrediction]; 
  currentPlayer++; 
  currentPlayer < players.length ? showPrediction() : showResultSelect(); 
}

/* 結果 */
function showResultSelect(){ 
  tempResult=[]; activeResultSlot=0; 
  updateResultSlots(); 
  $("resultChoices").innerHTML = menus.map((m,i)=>`<button class="btn-start" onclick="selectResult(${i+1})">${i+1}. ${m.name}</button>`).join(""); 
  show("screen-result"); 
}

function setActiveResultSlot(i){ activeResultSlot=i; updateResultSlots(); }

function updateResultSlots(){ 
  [$("rslot1"), $("rslot2"), $("rslot3")].forEach((s,i)=>{ 
    s.innerText = tempResult[i] ? menus[tempResult[i]-1].name : "未選択"; 
  }); 
  [0,1,2].forEach(idx => {
    $("rslot_ui"+idx).classList.toggle("active", idx === activeResultSlot);
  });
}

function selectResult(n){ 
  tempResult[activeResultSlot]=Number(n); 
  updateResultSlots(); 
  if(activeResultSlot < 2) {
    activeResultSlot++;
    updateResultSlots();
  }
}

function judge(){
  if(new Set(tempResult).size !== 3) return alert("3位まで重複なく選択してください");
  $("raceTitle").innerText = randomRaceName($("shopInput").value || "王将");
  $("ticketDate").innerText = today();
  $("ticketResult").innerHTML = tempResult.map((n,i)=>`${i+1}着：${menus[n-1].name}（${menus[n-1].odds}倍）`).join("<br>");
  
  let combinedOdds=1; tempResult.forEach(n=>combinedOdds*=parseFloat(menus[n-1].odds));
  $("ticketOdds").innerHTML = `<strong>確定オッズ：</strong>${combinedOdds.toFixed(1)}倍`;
  
  let winners = players.filter(p=>p.prediction.every((v,i)=>v===tempResult[i])).map(p=>p.name);
  $("ticketWinners").innerHTML = players.map(p=>{ 
    const hit = p.prediction.filter((v,i)=>v===tempResult[i]).length; 
    const mark = hit===3 ? "◎ 的中！" : (hit===2 ? "◯ 惜しい" : "× はずれ");
    return `${mark} ${p.name}`; 
  }).join("<br>");
  
  $("ticketPredictions").innerHTML = "<strong>【予想一覧】</strong><br>"+players.map(p=>`・${p.name}：${p.prediction.map(i=>menus[i-1].name).join(" → ")}`).join("<br>");
  
  const history = JSON.parse(localStorage.getItem("chukaHistory")||"[]");
  history.unshift({ title: $("raceTitle").innerText, date: today(), menus: tempResult.map(n=>({name:menus[n-1].name,odds:menus[n-1].odds})), combinedOdds:combinedOdds.toFixed(1), winners:winners });
  localStorage.setItem("chukaHistory", JSON.stringify(history.slice(0,20)));
  show("screen-ticket");
}

/* 履歴表示 */
function showHistory(){
  const h=JSON.parse(localStorage.getItem("chukaHistory")||"[]");
  if(h.length===0){ $("historyList").innerHTML="履歴がありません"; }
  else{
    $("historyList").innerHTML=h.map(v=>{
      const menuList=v.menus.map((m,i)=>`${i+1}着：${m.name}`).join(" / ");
      return `<div class="box"><strong>${v.title}</strong> (${v.date})<br>${menuList}<br>オッズ：${v.combinedOdds}倍</div>`;
    }).join("");
  }
  show("screen-history");
}

function resetApp(){ menus=[]; players=[]; currentPlayer=0; $("menuList").innerHTML="メニューが追加されていません"; $("playerList").innerHTML="参加者がいません"; show("screen-menu"); }
</script>

</body>
</html>
